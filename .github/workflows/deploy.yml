# å¯åŠ¨ä¹‹å‰ï¼ŒæŠŠç¯å¢ƒå˜é‡æ”¾åˆ°æœåŠ¡å™¨çš„ä½ç½®
name: ğŸš€ Monorepo éƒ¨ç½²åˆ°æœåŠ¡å™¨ 

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  BUN_VERSION: 'latest'
  FRONTEND_REMOTE_PATH: '/opt/1panel/www/sites/gina/index'
  BACKEND_REMOTE_PATH: '/2'
  SFTP_PORT: '22'
  # å‰ç«¯ç¯å¢ƒå˜é‡
  VITE_API_URL: "http://11.11.11.11:9012"
  VITE_HUAWEI_DOMAIN: "http://img.xxxx.top"

jobs:
  check-deploy:
    runs-on: ubuntu-latest
    outputs:
      should-deploy: ${{ steps.check.outputs.should-deploy }}
    steps:
      - name: Check if commit message starts with 'deploy'
        id: check
        run: |
          echo "Commit message: ${{ github.event.head_commit.message }}"
          if [[ "${{ github.event.head_commit.message }}" == deploy* ]]; then
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          else
            echo "should-deploy=false" >> $GITHUB_OUTPUT
          fi

  build-and-deploy:
    needs: check-deploy
    if: needs.check-deploy.outputs.should-deploy == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v5

      - name: ğŸ“¦ Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: ğŸ“¥ å®‰è£…ä¾èµ– (Monorepo)
        run: bun install
      
      - name: ğŸ”§ åˆ›å»ºå‰ç«¯ç¯å¢ƒå˜é‡æ–‡ä»¶
        run: |
          echo "åˆ›å»ºå‰ç«¯ç¯å¢ƒå˜é‡æ–‡ä»¶..."
          cd apps/frontend
          cat > .env.production << EOF
          VITE_API_URL=${{ env.VITE_API_URL }}
          VITE_HUAWEI_DOMAIN=${{ env.VITE_HUAWEI_DOMAIN }}
          EOF
          echo "âœ… å‰ç«¯ç¯å¢ƒå˜é‡æ–‡ä»¶åˆ›å»ºå®Œæˆï¼š"
          cat .env.production


      - name: ğŸ—ï¸ æ„å»ºæ‰€æœ‰é¡¹ç›® (Turbo)
        run: bun run build

      - name: ğŸ” æ£€æŸ¥é¡¹ç›®ç»“æ„
        run: |
          echo "=== å½“å‰å·¥ä½œç›®å½• ==="
          pwd
          echo "=== æ ¹ç›®å½•å†…å®¹ ==="
          ls -la
          echo "=== å¯»æ‰¾ apps ç›®å½• ==="
          find . -name "apps" -type d 2>/dev/null || echo "æœªæ‰¾åˆ° apps ç›®å½•"
          echo "=== å¯»æ‰¾ frontend ç›¸å…³ç›®å½• ==="
          find . -name "frontend" -type d 2>/dev/null || echo "æœªæ‰¾åˆ° frontend ç›®å½•"
          echo "=== å¯»æ‰¾ backend ç›¸å…³ç›®å½• ==="
          find . -name "backend" -type d 2>/dev/null || echo "æœªæ‰¾åˆ° backend ç›®å½•"
          echo "=== å¯»æ‰¾ dist ç›®å½• ==="
          find . -name "dist" -type d 2>/dev/null || echo "æœªæ‰¾åˆ° dist ç›®å½•"

      - name: ğŸ“¦ å‡†å¤‡å‰ç«¯éƒ¨ç½²æ–‡ä»¶
        run: |
          echo "å‡†å¤‡å‰ç«¯æ„å»ºäº§ç‰©..."
          if [ -d "apps/frontend/dist" ]; then
            echo "âœ… å‰ç«¯æ„å»ºäº§ç‰©å­˜åœ¨"
            ls -la apps/frontend/dist/
          else
            echo "âŒ å‰ç«¯æ„å»ºäº§ç‰©ä¸å­˜åœ¨"
            exit 1
          fi

      - name: ğŸ“¦ å‡†å¤‡åç«¯éƒ¨ç½²æ–‡ä»¶
        run: |
          echo "å‡†å¤‡åç«¯éƒ¨ç½²æ–‡ä»¶..."
          
          # æ£€æŸ¥åç«¯æ„å»ºç»“æœ
          if [ ! -d "apps/backend/dist" ]; then
            echo "âŒ åç«¯æ„å»ºäº§ç‰©ä¸å­˜åœ¨"
            exit 1
          fi
          
          # åˆ›å»ºéƒ¨ç½²ç›®å½•
          mkdir -p backend-deploy
          
          # å¤åˆ¶æ ¸å¿ƒæ–‡ä»¶ï¼ˆä¸åŒ…å«ç¯å¢ƒå˜é‡æ–‡ä»¶ï¼‰
          echo "å¤åˆ¶ package.json..."
          cp apps/backend/package.json backend-deploy/
          
          echo "å¤åˆ¶æ„å»ºäº§ç‰©..."
          cp -r apps/backend/dist backend-deploy/
          
          echo "å¤åˆ¶ç®¡ç†è„šæœ¬..."
          cp apps/backend/start.sh backend-deploy/ 2>/dev/null || echo "start.sh not found, skipping"
          cp apps/backend/stop.sh backend-deploy/ 2>/dev/null || echo "stop.sh not found, skipping"
          cp apps/backend/status.sh backend-deploy/ 2>/dev/null || echo "status.sh not found, skipping"
          
          echo "âš ï¸ æ³¨æ„ï¼šç¯å¢ƒå˜é‡æ–‡ä»¶(.env*)å°†ç”±ç”¨æˆ·æ‰‹åŠ¨ç®¡ç†ï¼Œä¸ä¼šè¢«éƒ¨ç½²æµç¨‹è¦†ç›–"
          
          echo "âœ… éƒ¨ç½²æ–‡ä»¶å‡†å¤‡å®Œæˆï¼š"
          ls -la backend-deploy/

      - name: ğŸ“ åˆ›å»ºè¿œç¨‹ç›®å½•
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ env.SFTP_PORT || 22 }}
          script: |
            echo "åˆ›å»ºè¿œç¨‹ç›®å½•..."
            mkdir -p ${{ env.FRONTEND_REMOTE_PATH }}
            mkdir -p ${{ env.BACKEND_REMOTE_PATH }}
            echo "âœ… ç›®å½•åˆ›å»ºå®Œæˆ"
            ls -la ${{ env.FRONTEND_REMOTE_PATH }}
            ls -la ${{ env.BACKEND_REMOTE_PATH }}

      - name: ğŸŒ éƒ¨ç½²å‰ç«¯ (SFTP)
        uses: wlixcc/SFTP-Deploy-Action@v1.2.4
        with:
          username: ${{ secrets.SFTP_USER }}
          server: ${{ secrets.SFTP_HOST }}
          port: ${{ env.SFTP_PORT || 22 }}
          ssh_private_key: ${{ secrets.SSH_PRIVATE_KEY }}
          local_path: './apps/frontend/dist/*'
          remote_path: ${{ env.FRONTEND_REMOTE_PATH }}
          sftp_only: false
          sftpArgs: '-o ConnectTimeout=10'
          delete_remote_files: true

      - name: ğŸ›‘ åœæ­¢åç«¯æœåŠ¡
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ env.SFTP_PORT || 22 }}
          script: |
            cd ${{ env.BACKEND_REMOTE_PATH }}
            
            echo "=== ğŸ›‘ éƒ¨ç½²å‰åœæ­¢æœåŠ¡ ==="
            
            # è®¾ç½® shell è„šæœ¬æƒé™
            chmod +x ./*.sh 2>/dev/null || echo "No shell scripts found"
            
            # åœæ­¢ç°æœ‰æœåŠ¡
            if [ -f "./stop.sh" ]; then
              echo "ä½¿ç”¨ stop.sh åœæ­¢æœåŠ¡"
              ./stop.sh || echo "æœåŠ¡æœªè¿è¡Œæˆ–åœæ­¢å¤±è´¥"
            else
              echo "ä½¿ç”¨å¤‡ç”¨åœæ­¢æ–¹æ³•"
              pkill -f "bun.*start" 2>/dev/null || echo "æ²¡æœ‰æ‰¾åˆ°è¿è¡Œä¸­çš„æœåŠ¡"
              rm -f app.pid
            fi
            
            # ç­‰å¾…æœåŠ¡å®Œå…¨åœæ­¢
            sleep 3
            
            echo "=== âœ… æœåŠ¡åœæ­¢å®Œæˆ ==="

      - name: ğŸš€ éƒ¨ç½²åç«¯ (SFTP) - ä¿æŠ¤ç¯å¢ƒå˜é‡æ–‡ä»¶
        uses: wlixcc/SFTP-Deploy-Action@v1.2.4
        with:
          username: ${{ secrets.SFTP_USER }}
          server: ${{ secrets.SFTP_HOST }}
          port: ${{ env.SFTP_PORT || 22 }}
          ssh_private_key: ${{ secrets.SSH_PRIVATE_KEY }}
          local_path: './backend-deploy/*'
          remote_path: ${{ env.BACKEND_REMOTE_PATH }}
          sftp_only: false
          sftpArgs: '-o ConnectTimeout=10'
          delete_remote_files: false

      - name: ğŸ† å¯åŠ¨åç«¯æœåŠ¡
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ env.SFTP_PORT || 22 }}
          script: |
            cd ${{ env.BACKEND_REMOTE_PATH }}
            
            echo "=== ğŸ† å¯åŠ¨åç«¯æœåŠ¡ ==="
            
            # æ£€æŸ¥ç¯å¢ƒå˜é‡æ–‡ä»¶
            echo "æ£€æŸ¥ç¯å¢ƒå˜é‡æ–‡ä»¶..."
            if [ -f ".env" ]; then
              echo "âœ… .env æ–‡ä»¶å­˜åœ¨"
            else
              echo "âš ï¸ .env æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·æ‰‹åŠ¨ä¸Šä¼ "
            fi
            
            if [ -f ".env.production" ]; then
              echo "âœ… .env.production æ–‡ä»¶å­˜åœ¨"
            else
              echo "âš ï¸ .env.production æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·æ‰‹åŠ¨ä¸Šä¼ "
            fi
            
            # è®¾ç½® shell è„šæœ¬æƒé™
            chmod +x ./*.sh 2>/dev/null || echo "No shell scripts found"
            
            # å¯åŠ¨æœåŠ¡
            if [ -f "./start.sh" ]; then
              echo "ä½¿ç”¨ start.sh å¯åŠ¨æœåŠ¡"
              ./start.sh
            else
              echo "ä½¿ç”¨å¤‡ç”¨å¯åŠ¨æ–¹æ³•"
              export PATH="/root/.bun/bin:$PATH"
              export NODE_ENV=production
              mkdir -p logs
              nohup bun run start > logs/app.log 2>&1 &
              echo $! > app.pid
              echo "æœåŠ¡å·²å¯åŠ¨ï¼ŒPID: $(cat app.pid)"
            fi
            
            echo "=== âœ… æœåŠ¡å¯åŠ¨å®Œæˆ ==="

      - name: ğŸ” éƒ¨ç½²åéªŒè¯
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SFTP_HOST }}
          username: ${{ secrets.SFTP_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ env.SFTP_PORT || 22 }}
          script: |
            cd ${{ env.BACKEND_REMOTE_PATH }}
            
            echo "=== ğŸ” æœ€ç»ˆéªŒè¯ ==="
            
            # ç­‰å¾…æœåŠ¡å®Œå…¨å¯åŠ¨
            sleep 10
            
            # ä½¿ç”¨ status.sh è¿›è¡Œæœ€ç»ˆéªŒè¯
            if [ -f "./status.sh" ]; then
              echo "ä½¿ç”¨ status.sh è¿›è¡Œæœ€ç»ˆéªŒè¯..."
              ./status.sh
              
              # æ£€æŸ¥æœåŠ¡æ˜¯å¦çœŸçš„åœ¨è¿è¡Œ
              if [ -f "app.pid" ]; then
                PID=$(cat app.pid)
                if ps -p $PID > /dev/null 2>&1; then
                  echo "ğŸ‰ éƒ¨ç½²éªŒè¯æˆåŠŸï¼šæœåŠ¡æ­£åœ¨è¿è¡Œ (PID: $PID)"
                else
                  echo "âŒ éƒ¨ç½²éªŒè¯å¤±è´¥ï¼šæœåŠ¡æœªè¿è¡Œ"
                  exit 1
                fi
              else
                echo "âŒ éƒ¨ç½²éªŒè¯å¤±è´¥ï¼šæœªæ‰¾åˆ° PID æ–‡ä»¶"
                exit 1
              fi
            else
              echo "âš ï¸ æœªæ‰¾åˆ° status.shï¼Œè·³è¿‡è¯¦ç»†éªŒè¯"
            fi
            
            echo "=== ğŸ‰ éªŒè¯å®Œæˆ ==="

  notify-deployment:
    needs: [check-deploy, build-and-deploy]
    if: always() && needs.check-deploy.outputs.should-deploy == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“Š éƒ¨ç½²çŠ¶æ€é€šçŸ¥
        run: |
          if [[ "${{ needs.build-and-deploy.result }}" == "success" ]]; then
            echo "ğŸ‰ Monorepo éƒ¨ç½²æˆåŠŸï¼"
            echo "âœ… å‰ç«¯å·²éƒ¨ç½²åˆ°ï¼š${{ env.FRONTEND_REMOTE_PATH }}"
            echo "âœ… åç«¯å·²éƒ¨ç½²åˆ°ï¼š${{ env.BACKEND_REMOTE_PATH }}"
            echo "ğŸš€ ä½¿ç”¨ Turbo + Bun ä¸€æ¬¡æ„å»ºï¼Œåˆ†åˆ«éƒ¨ç½²"
          else
            echo "âŒ Monorepo éƒ¨ç½²å¤±è´¥ï¼"
            echo "çŠ¶æ€: ${{ needs.build-and-deploy.result }}"
            exit 1
          fi